const Game = ((player1, player2) => {
  let whoIsPlaying = player1;
  let player1Turn = true;
  let endGame = { gameOver: false, winner: {name: null, mark: null} };

  const gridStructure = [1, 2, 3, 4, 5, 6, 7, 8, 9];

  const populateBoard = () => {
    const field = document.getElementById('board');
    console.log('field', field);
    gridStructure.forEach((element) => {
      const div = document.createElement('div');
      div.className = "grid-item";
      div.id = element;
      div.innerText = '';
      div.addEventListener('click', boxIsClicked)
      field.appendChild(div);
    })
  }

  const boxIsClicked = (e) => {
    e.target.innerText = checkSquare(e.target.id);
    if (endGame.gameOver) {
      declareWinner(endGame.winner);
      stopFurtherClicking();
    }
    e.currentTarget.removeEventListener(e.type, boxIsClicked);
  }

  const playerTurn = () => {
    if (player1Turn) {
      whoIsPlaying = player2;
      player1Turn = false;
    } else {
      whoIsPlaying = player1;
      player1Turn = true;
    }
  }

  const checkSquare = (value) => {
    const isGameOver = whoIsPlaying.markSquare(value);
    const result = whoIsPlaying.mark;
    if (!isGameOver) {
      playerTurn();
      return result;
    }
    endGame.gameOver = isGameOver;
    endGame.winner = {name: whoIsPlaying.name, mark: whoIsPlaying.mark}
    return result;
  }

  const declareWinner = (winner) => {
    const theWinnerIs = document.getElementById('winnerTag');
    const div = document.createElement('div');
    div.className = 'winner';
    div.innerText = `${winner.name} of ${winner.mark} is the winner!`
    theWinnerIs.append(div);
  }

  const stopFurtherClicking = () => {
    const gridElements = document.getElementsByClassName('grid-item');
    for (let i = 0; i <= gridElements.length - 1; i++) {
      gridElements.item(i).removeEventListener('click', boxIsClicked);
    }
  }

  const removeWinner = () => {
    const theWinnerIs = document.getElementById('winnerTag');
    while (theWinnerIs.lastChild) {
      theWinnerIs.removeChild(theWinnerIs.lastChild);
    }
    endGame.gameOver = false;
    endGame.winner = {name: null, mark: null};
  }

  const resetBoard = () => {
    const field = document.getElementById('board');
      while (field.lastChild) {
        field.removeChild(field.lastChild);
      }
    player1.resetMarkedSquares();
    player2.resetMarkedSquares();
    removeWinner();
    populateBoard();
  }

  return {
    gridStructure,
    checkSquare,
    endGame,
    populateBoard,
    resetBoard,
  }
});

const Player = ((name, mark) => {
  let squaresMarked = [];
  const winConditions = [
    [1, 2, 3], [4, 5, 6], [7, 8, 9], //across
    [1, 4, 7], [2, 5, 8], [3, 6, 9], //down
    [1, 5, 9], [3, 5, 7] //diagonal
  ];

  const markSquare = (gridSquare) => {
    square = parseInt(gridSquare);
    if (!squaresMarked.includes(square)) {
      squaresMarked.push(square);
    }
    if (squaresMarked.length >= 3) {
      const isWinner = checkWin()
      return isWinner;
    }
  }

  const resetMarkedSquares = () => {
    squaresMarked = [];
  };

  function checkWin() {
    let isWinner = false;
    winConditions.forEach((sequence) => {
      let counter = 0;
      if (!isWinner) {
        squaresMarked.forEach((square) => {
          if (!sequence.includes(square)) {
            return
          }
          counter++;
        })
        if (counter === 3) {
          isWinner = true;
        } else {
          counter === 0;
        }
      }
    })
    return isWinner;
  }
  return {name, mark, markSquare, resetMarkedSquares};
});

const Environment = (board) => {
  const gameBoard = board;
  const buttonArray = [];

  const makeEnv = () => {
    const baseLayer = document.getElementById('environment');
    console.log('baselayer', baseLayer);
    const boardDiv = document.createElement('div');
    const controls = document.createElement('div');
    const announcement = document.createElement('div');

    boardDiv.id = 'board';
    boardDiv.className = 'grid-container';
    controls.id = 'buttons';
    announcement.id = 'winnerTag';

    baseLayer.appendChild(boardDiv);
    baseLayer.appendChild(controls);
    baseLayer.appendChild(announcement);

    gameBoard.populateBoard();
  }

  const buttons = {
    reset:{
      name: 'reset',
      function: gameBoard.resetBoard,
    }
  };
  buttonArray.push(buttons.reset);

  const addButtons = () => {
    const div = document.getElementById('buttons');
    console.log(buttonArray);
    buttonArray.forEach((button) => {
      btn = document.createElement('btn');
      btn.id = 'btn';
      btn.textContent = `${button.name}`;
      btn.addEventListener('click', button.function);
      div.appendChild(btn);
    })
  }

  return {makeEnv, addButtons};
}

function main() {
  const player1 = Player('bob', 'X');
  const player2 = Player('bill', 'O');
  const board = Game(player1, player2)
  const initialize = Environment(board);
  initialize.makeEnv();
  initialize.addButtons();
}

main();
